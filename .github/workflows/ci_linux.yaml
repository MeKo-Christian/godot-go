name: godot-go CI on Linux

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "**/*.go"
      - "**/*.c"
      - "**/*.h"
      - "**/*.gdextension"
      - ".github/workflows/ci_linux.yaml"

  push:
    branches:
      - main
    paths:
      - "**/*.go"
      - "**/*.c"
      - "**/*.h"
      - "**/*.gdextension"
      - ".github/workflows/ci_linux.yaml"

jobs:
  run_test:
    name: "run tests"
    strategy:
      fail-fast: true
      matrix:
        os:
          - linux
        arch:
          - amd64

    runs-on: ubuntu-latest
    env:
      GODOT: /usr/local/bin/godot
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Add Go 1.25 To System Path
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.0"

      - run: go version

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.61.0
          args: --version

      - run: mkdir -p bin/

      - name: Install Godot 4.5 stable
        run: |
          wget https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip
          sudo unzip Godot_v4.5-stable_linux.x86_64.zip -d /usr/local/bin
          sudo ln -s Godot_v4.5-stable_linux.x86_64 /usr/local/bin/godot

      # - name: Download Godot binary
      #   uses: dawidd6/action-download-artifact@v2
      #   with:
      #     workflow: ci_build_godot_linux.yaml
      #     workflow_conclusion: success
      #     name: godot-linuxbsd-editor-amd64
      #     path: bin/

      - name: Setup Godot binary
        run: |
          sudo chmod +x /usr/local/bin/godot
          ls -alh /usr/local/bin/

      - name: Update Godot Headers
        run: |
          just update_godot_headers_from_binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}

      - name: Code Generation
        run: |
          PATH=$PATH:$(go env GOPATH)/bin just generate
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}

      - run: git diff

      - name: Lint
        run: just lint

      - name: Build
        run: just build
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}

      - name: List Artifacts Directory
        run: |
          ls -alh test/demo/lib

      - name: Gen Test Project Files
        if: ${{ matrix.os == 'linux' }}
        timeout-minutes: 3
        run: |
          just ci_gen_test_project_files
        continue-on-error: true
        env:
          CI: 1
          LOG_LEVEL: "debug"
          LANG: "en_US.utf8"

      - name: Test
        if: ${{ matrix.os == 'linux' }}
        timeout-minutes: 2
        run: |
          just test
        env:
          CI: 1
          LOG_LEVEL: "debug"
          LANG: "en_US.utf8"

  leak_test:
    name: "leak test"
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      GODOT: /usr/local/bin/godot
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Add Go 1.25 To System Path
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.0"

      - run: go version

      - name: Install just
        uses: extractions/setup-just@v2

      - run: mkdir -p bin/

      - name: Install Godot 4.5 stable
        run: |
          wget https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip
          sudo unzip Godot_v4.5-stable_linux.x86_64.zip -d /usr/local/bin
          sudo ln -s Godot_v4.5-stable_linux.x86_64 /usr/local/bin/godot

      - name: Setup Godot binary
        run: |
          sudo chmod +x /usr/local/bin/godot
          ls -alh /usr/local/bin/

      - name: Update Godot Headers
        run: |
          just update_godot_headers_from_binary
        env:
          GOOS: linux
          GOARCH: amd64

      - name: Code Generation
        run: |
          PATH=$PATH:$(go env GOPATH)/bin just generate
        env:
          GOOS: linux
          GOARCH: amd64

      - name: Build
        run: just build
        env:
          GOOS: linux
          GOARCH: amd64

      - name: Gen Test Project Files
        timeout-minutes: 3
        run: |
          just ci_gen_test_project_files
        continue-on-error: true
        env:
          CI: 1
          LOG_LEVEL: "debug"
          LANG: "en_US.utf8"

      - name: Leak Test
        timeout-minutes: 15
        run: |
          just leak_test
        env:
          CI: 1
          LOG_LEVEL: "debug"
          LANG: "en_US.utf8"
